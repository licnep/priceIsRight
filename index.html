<head>
  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
</head>

<script>



///////////////////////////////////////////////////////////////////////////////
// Funzioni per frontend                                                     //
///////////////////////////////////////////////////////////////////////////////

//Legge il parametro g= dall'url, che contiene l'ID della partita a cui unirsi
//Se non c'e' nessun parametro g nell'url, allora crea una nuova partita
var server = new URLSearchParams(window.location.search).get('g');
if (server) {
    //l'utente ha cliccato un link per unirsi alla partita
    //TODO: mostrare un input per inserire il nome giocatore e confermare
} else {
    //crea una nuova partita
    //TODO: mostrare l'input per inserire il nome giocatore e il numero di oggetti
}


//va chiamata quando l'utente clicca crea una nuova partita
function clickCreaPartita(nomeGiocatore, numeroOggetti = 5) {
  window.nOggetti = numeroOggetti;
  window.nomeGiocatore = nomeGiocatore || id;
  window.turno = 0;
  window.listaGiocatori = new Array();
  window.listaGiocatori.push({"nome": window.nomeGiocatore, "id": id, "punteggio": 0});
  console.log(window.nOggetti, window.linkPartita) //linkPartita sara' il link da condividere con gli altri giocatori
  //TODO: Mostrare a schermo il link partita da condividere, e la lista giocatori
}

//viene chiamata quando un giocatore si connette alla partita
function onGiocatoreConnesso(idGiocatore, nomeGiocatore) {
  window.listaGiocatori.push({"nome": nomeGiocatore || idGiocatore, "id": idGiocatore, "punteggio": 0});
  console.log(listaGiocatori);
  //TODO: aggiungere il giocatore alla lista giocatori 
}

//va chiamata quando l'utente host clicca "avvia partita"
function clickAvviaPartita() {
  prossimoRound();
}

//Genera un oggetto casuale e lo invia a tutti i giocatori
function prossimoRound() {
  if (turno == nOggetti) {
    console.log("partita finita");
    partitaFinita();
    return;
  }

  turno += 1;
  console.log("Turno", turno);
  window.puntate = {};

  window.product = randomProduct();
  send("product:" + JSON.stringify(product));
  mostraOggettoMisterioso(product);
}

function mostraOggettoMisterioso(product) {
  //product = {"Image":[lista di url immagini], "Product Name": nome_prodotto, "Selling Price":prezzo}
  //TODO: mostra l'oggetto da indovinare e l'input per inserire il prezzo
  for (img of product["Image"]) {
    document.write('<img src="'+img+'"></img>');
  }
}

//viene chiamata quando un giocatore invia la sua risposta
function onPuntata(idGiocatore, puntata) {
  window.puntate[idGiocatore] = puntata;
}

//viene chiamata quando scade il tempo per il round, mostra l'oggetto svelato
function onTempoScaduto() {
  alert(product["Selling Price"]);
  //aggiorna i punteggi giocatori
  for (i in listaGiocatori) {
    listaGiocatori[i]["punteggio"] += Math.abs( ( (puntate[listaGiocatori[i]["id"]] || 0) / product["Selling Price"]) - 1);
  }
  console.log(listaGiocatori);
}

function partitaFinita() {
  //TODO mostra classifica finale e tasto per rigiocare o creare un'altra partita
}

function clickRiavviaPartita() {
  window.turno = 0;
  //azzera i punteggi
  for (i in listaGiocatori) {
    listaGiocatori[i]["punteggio"] = 0;
  }
  prossimoRound();
}

///////////////////////////////////////////////////////////////////////////////
</script>
<script src="priceisright.js"></script>